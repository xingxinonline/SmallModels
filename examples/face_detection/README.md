# 人脸检测示例 (Face Detection Demo)

本示例演示如何在本地 PC 上运行人脸检测模型，作为 S300 芯片部署前的验证。

## 🏗️ 架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                      人脸检测系统架构                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │   摄像头输入   │───▶│   图像预处理   │───▶│   SCRFD 人脸检测    │  │
│  │  (Camera)    │    │ (Preprocess) │    │   (ONNX Runtime)    │  │
│  └──────────────┘    └──────────────┘    └──────────────────────┘  │
│                                                    │                │
│                                                    ▼                │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │   屏幕显示    │◀───│   绘制边框    │◀───│   后处理 (NMS)       │  │
│  │  (Display)   │    │ (Draw Boxes) │    │  (Postprocess)       │  │
│  └──────────────┘    └──────────────┘    └──────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 模块说明

| 模块              | 功能                 | 技术选型            |
| ----------------- | -------------------- | ------------------- |
| **CameraCapture** | 摄像头视频采集       | OpenCV VideoCapture |
| **Preprocessor**  | 图像尺寸调整、归一化 | NumPy / OpenCV      |
| **FaceDetector**  | SCRFD 模型推理       | ONNX Runtime        |
| **Postprocessor** | NMS 去重、坐标还原   | NumPy               |
| **Visualizer**    | 绘制检测框、显示画面 | OpenCV              |

### 数据流

1. **采集**: 从摄像头读取 BGR 图像帧
2. **预处理**: Resize 到模型输入尺寸 (640x640)，归一化到 [0,1]
3. **推理**: ONNX Runtime 执行 SCRFD 模型
4. **后处理**: 解码边界框、应用 NMS、过滤低置信度
5. **可视化**: 在原图上绘制检测框，显示 FPS

## 📁 文件结构

```
examples/face_detection/
├── README.md           # 本文档
├── config.py           # 配置参数
├── camera.py           # 摄像头采集模块
├── detector.py         # 人脸检测器 (SCRFD)
├── visualizer.py       # 可视化模块
├── main.py             # 主程序入口
├── download_model.py   # 模型下载脚本
└── models/             # 模型文件目录
    └── .gitkeep
```

## 🚀 快速开始

### 1. 安装依赖

```bash
uv add opencv-python onnxruntime numpy
```

### 2. 下载模型

```bash
python download_model.py
```

### 3. 运行演示

```bash
python main.py
```

### 4. 操作说明

- 按 `q` 键退出程序
- 按 `s` 键保存当前帧截图

## 🔧 配置参数

在 `config.py` 中可调整以下参数：

| 参数                   | 默认值     | 说明           |
| ---------------------- | ---------- | -------------- |
| `CAMERA_ID`            | 0          | 摄像头设备 ID  |
| `CAMERA_WIDTH`         | 640        | 采集分辨率宽度 |
| `CAMERA_HEIGHT`        | 480        | 采集分辨率高度 |
| `MODEL_INPUT_SIZE`     | (640, 640) | 模型输入尺寸   |
| `CONFIDENCE_THRESHOLD` | 0.5        | 置信度阈值     |
| `NMS_THRESHOLD`        | 0.4        | NMS IoU 阈值   |

## 📊 性能指标 (本地 PC)

| 指标     | 数值                     |
| -------- | ------------------------ |
| 模型     | SCRFD-500M               |
| 输入尺寸 | 640x640                  |
| 推理时间 | ~15ms (CPU) / ~5ms (GPU) |
| FPS      | 60+                      |

## 🎯 S300 部署注意事项

本地验证通过后，移植到 S300 需要：

1. **模型量化**: FP32 → INT8 (使用 ONNX Quantization Tools)
2. **算子检查**: 确保所有算子在 S300 NPU 支持列表内
3. **内存优化**: 检查模型是否超过 NPU 内存限制 (516KB)
4. **接口适配**: DVP 摄像头接口替代 USB 摄像头
