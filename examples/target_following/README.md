# 目标跟随系统 (Target Following System)

基于手势控制的人脸/人体识别与跟随系统，适用于机器人、无人机等场景。

## 🏗️ 系统架构

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                          目标跟随系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────────────────────────────────────────┐    │
│  │  摄像头输入  │───▶│              多模型推理管道                      │    │
│  │  (Camera)   │    │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │    │
│  └─────────────┘    │  │手势识别  │  │人脸检测  │  │  人体检测       │ │    │
│                     │  │MediaPipe│  │ SCRFD   │  │ YOLOv8-Pose    │ │    │
│                     │  └────┬────┘  └────┬────┘  └───────┬────────┘ │    │
│                     └───────┼────────────┼───────────────┼──────────┘    │
│                             │            │               │                │
│                             ▼            ▼               ▼                │
│                     ┌───────────────────────────────────────────────┐    │
│                     │              状态机控制器                       │    │
│                     │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐│    │
│                     │  │ IDLE    │─▶│TRACKING │─▶│  LOST_TARGET   ││    │
│                     │  │ 空闲    │  │ 跟随中  │  │   目标丢失      ││    │
│                     │  └─────────┘  └─────────┘  └─────────────────┘│    │
│                     └───────────────────────────────────────────────┘    │
│                                         │                                 │
│                                         ▼                                 │
│  ┌─────────────┐    ┌─────────────────────────────────────────────────┐  │
│  │  屏幕显示   │◀───│  跟随目标坐标输出 (x, y, w, h, confidence)      │  │
│  │  (Display)  │    │  可扩展到云台/机器人控制                         │  │
│  └─────────────┘    └─────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

## 📋 功能说明

### 手势控制
| 手势                   | 动作      | 说明                             |
| ---------------------- | --------- | -------------------------------- |
| ✋ 张开手掌 (Open Palm) | 启动跟随  | 记录当前人脸和人体特征，开始跟随 |
| ✊ 握拳 (Closed Fist)   | 停止跟随  | 停止跟随，返回空闲状态           |
| ✌️ 剪刀手 (Victory)     | 暂停/恢复 | 暂停或恢复跟随                   |

### 跟随逻辑
1. **启动**: 检测到启动手势后，锁定当前画面中最近的人脸和人体
2. **跟随**: 持续追踪目标，输出目标位置坐标
3. **丢失**: 目标消失时保持最后位置，等待目标重新出现
4. **停止**: 检测到停止手势后，清除目标特征，返回空闲

### 状态机
```text
    ┌──────────────────────────────────────────────────┐
    │                                                  │
    ▼                                                  │
┌────────┐  Open Palm   ┌──────────┐  Target Lost  ┌──────────────┐
│  IDLE  │─────────────▶│ TRACKING │──────────────▶│ LOST_TARGET  │
│  空闲  │              │  跟随中   │◀──────────────│  目标丢失    │
└────────┘◀─────────────┴──────────┘  Target Found └──────────────┘
              Fist           │                           │
                             │         Fist              │
                             └───────────────────────────┘
```

## 📁 文件结构

```text
examples/target_following/
├── README.md               # 本文档
├── config.py               # 配置参数
├── models/                 # 模型文件目录
│   └── .gitkeep
├── detectors/              # 检测器模块
│   ├── __init__.py
│   ├── gesture_detector.py # 手势检测 (MediaPipe)
│   ├── face_detector.py    # 人脸检测 (SCRFD)
│   ├── face_recognizer.py  # 人脸识别 (特征提取)
│   └── person_detector.py  # 人体检测 (YOLOv8-Pose)
├── trackers/               # 跟踪器模块
│   ├── __init__.py
│   └── target_tracker.py   # 目标跟踪器
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── state_machine.py    # 状态机
│   └── camera.py           # 摄像头
├── utils/                  # 工具模块
│   ├── __init__.py
│   └── visualizer.py       # 可视化
├── tests/                  # 单独验证脚本
│   ├── test_gesture.py     # 手势识别测试
│   ├── test_face.py        # 人脸识别测试
│   └── test_person.py      # 人体检测测试
├── download_models.py      # 模型下载脚本
└── main.py                 # 主程序入口
```

## 🔧 模型选型

| 任务     | 模型                | 来源        | 大小   | 说明                  |
| -------- | ------------------- | ----------- | ------ | --------------------- |
| 手势识别 | MediaPipe Hands     | Google      | ~10MB  | 实时手部检测+手势分类 |
| 人脸检测 | SCRFD-500M          | InsightFace | ~2.5MB | 轻量级人脸检测        |
| 人脸识别 | ArcFace (w600k_r50) | InsightFace | ~166MB | 人脸特征提取          |
| 人体检测 | YOLOv8n-pose        | Ultralytics | ~6MB   | 人体检测+姿态估计     |

## 🚀 快速开始

### 1. 安装依赖

```bash
uv add opencv-python numpy onnxruntime mediapipe ultralytics
```

### 2. 下载模型

```bash
uv run python download_models.py
```

### 3. 单独验证

```bash
# 验证手势识别
uv run python tests/test_gesture.py

# 验证人脸识别
uv run python tests/test_face.py

# 验证人体检测
uv run python tests/test_person.py
```

### 4. 运行完整系统

```bash
uv run python main.py
```

## 📊 性能指标 (本地 PC)

| 模块     | 推理时间 | FPS     |
| -------- | -------- | ------- |
| 手势识别 | ~10ms    | 100+    |
| 人脸检测 | ~15ms    | 65+     |
| 人脸识别 | ~20ms    | 50+     |
| 人体检测 | ~25ms    | 40+     |
| **整体** | ~50ms    | **20+** |

## 🎯 S300 部署注意事项

1. **模型量化**: 所有模型需要 INT8 量化
2. **算子替换**: MediaPipe 需要自定义实现，建议用手部关键点分类替代
3. **内存优化**: 多模型串行执行以节省内存
4. **接口适配**: DVP 摄像头接口
